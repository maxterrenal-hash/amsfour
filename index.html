<script>
/* ============================================================
   CONFIG
============================================================ */
const API = "https://script.google.com/macros/s/AKfycbwONf1cXzlTDOOHBcuo0j0us-bb074G_UBXytkGHNp3IpUChWwqUWSjq3TVV264fLac/exec";

let ALL_DATA = [];
let FILTERED = [];
let CHARTS = {};


/* ============================================================
   LOAD DATA
============================================================ */
async function loadData() {
  try {
    const res = await fetch(API);
    const json = await res.json();
    ALL_DATA = (json.entries || []).map(normalize);
    applyFilters();
  } catch (err) {
    console.error("Fetch error:", err);
  }
}

/* Normalize sheet field name differences */
function normalize(e) {
  const d = e.data;

  d.reqdate = d.date || d.reqdate || d.timestamp?.substring(0,10);
  d.mode = title(d.mode);
  d.drugtype = title(d.drugtype);
  d.clinicaldept = d.clinicaldepartment || d.clinicaldept;
  d.idspecialist = d.infectiousdiseasespecialist || d.idspecialist || "";

  /* NEW for IDS TAT */
  d.foridsat = d["for ids at"] || d.foridsat || "";
  d.idsapprovedat = d["ids approved at"] || d.idsapprovedat || "";
  d.idsdisapprovedat = d["ids disapproved at"] || d.idsdisapprovedat || "";

  return { ...e, data: d };
}

function title(x) {
  if (!x) return "";
  return x.charAt(0).toUpperCase() + x.slice(1).toLowerCase();
}


/* ============================================================
   FILTER ENGINE
============================================================ */
function applyFilters() {
  const start = val("dateStart");
  const end = val("dateEnd");
  const mode = val("modeFilter");
  const drugType = val("drugTypeFilter");
  const ward = val("wardFilter");
  const dept = val("deptFilter");
  const ids = val("idsFilter");
  const search = val("searchBox").toLowerCase();

  FILTERED = ALL_DATA.filter(e => {
    const d = e.data;

    if (start && d.reqdate < start) return false;
    if (end && d.reqdate > end) return false;
    if (mode && d.mode !== mode) return false;
    if (drugType && d.drugtype !== drugType) return false;
    if (ward && d.ward !== ward) return false;
    if (dept && d.clinicaldept !== dept) return false;
    if (ids && d.idspecialist !== ids) return false;

    if (search) {
      const blob = (d.patientname||"") + (d.diagnosis||"") + (d.antimicrobial||"");
      if (!blob.toLowerCase().includes(search)) return false;
    }

    return true;
  });

  renderKPIs();
  renderRawTable();
  renderCharts();
}

function val(id) { return document.getElementById(id).value; }


/* ============================================================
   KPI ENGINE (with Live Dashboard + IDS TAT)
============================================================ */
function renderKPIs() {
  const total = FILTERED.length;

  const pending = FILTERED.filter(e => e.data.status === "pending").length;
  const forIDS = FILTERED.filter(e => e.data.status === "for_ids_approval").length;

  const restricted = FILTERED.filter(e => e.data.drugtype === "Restricted").length;
  const monitored = FILTERED.filter(e => e.data.drugtype === "Monitored").length;
  const approved = FILTERED.filter(e => e.data.status === "approved").length;

  const adult = FILTERED.filter(e => e.data.mode === "Adult").length;
  const pediatric = FILTERED.filter(e => e.data.mode === "Pediatric").length;

  /* LIVE DASHBOARD */
  document.getElementById("kpiPending").textContent = pending;
  document.getElementById("kpiForIDS").textContent = forIDS;

  document.getElementById("kpiTotal").textContent = total;
  document.getElementById("kpiRestricted").textContent = restricted;
  document.getElementById("kpiMonitored").textContent = monitored;
  document.getElementById("kpiApprovalRate").textContent =
    total ? ((approved / total) * 100).toFixed(1) + "%" : "0%";
  document.getElementById("kpiAgeRatio").textContent = `${adult} : ${pediatric}`;

  document.getElementById("kpiTurnaround").textContent = calcTAT(FILTERED) + " hr";

  /* IDS-specific Turnaround Time */
  document.getElementById("kpiIDSTAT").textContent = calcIDSTAT(FILTERED) + " hr";
}

/* Median TAT (Request Date → Decision) */
function calcTAT(list) {
  const arr = [];

  list.forEach(e => {
    const d = e.data;
    if (!d.reqdate) return;

    let start = new Date(d.reqdate);
    let end = d.idsapprovedat
      ? new Date(d.idsapprovedat)
      : d.idsdisapprovedat
      ? new Date(d.idsdisapprovedat)
      : null;

    if (!end) return;

    const h = (end - start) / 36e5;
    if (h > 0 && h < 5000) arr.push(h);
  });

  if (!arr.length) return 0;
  arr.sort((a,b)=>a-b);
  const m = Math.floor(arr.length/2);
  return arr.length%2 ? arr[m].toFixed(1) : ((arr[m-1]+arr[m])/2).toFixed(1);
}

/* NEW Median IDS TAT (For IDS → Decision) */
function calcIDSTAT(list) {
  const arr = [];

  list.forEach(e => {
    const d = e.data;
    if (!d.foridsat) return;

    const start = new Date(d.foridsat);
    const end = d.idsapprovedat
      ? new Date(d.idsapprovedat)
      : d.idsdisapprovedat
      ? new Date(d.idsdisapprovedat)
      : null;

    if (!end) return;

    const h = (end - start) / 36e5;
    if (h > 0 && h < 5000) arr.push(h);
  });

  if (!arr.length) return 0;
  arr.sort((a,b)=>a-b);
  const m = Math.floor(arr.length/2);
  return arr.length%2 ? arr[m].toFixed(1) : ((arr[m-1]+arr[m])/2).toFixed(1);
}


/* ============================================================
   RAW TABLE
============================================================ */
function renderRawTable() {
  const tb = document.getElementById("rawTable");
  tb.innerHTML = "";

  FILTERED.forEach(e => {
    const d = e.data;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.patientname||""}</td>
      <td>${d.age||""}</td>
      <td>${d.diagnosis||""}</td>
      <td>${d.antimicrobial||""}</td>
      <td>${d.drugtype||""}</td>
      <td>${d.ward||""}</td>
      <td>${d.residentname||""}</td>
      <td>${d.idspecialist||""}</td>
      <td>${d.status||""}</td>
      <td>${d.reqdate||""}</td>`;
    tb.appendChild(tr);
  });
}


/* ============================================================
   BASIC CHART HELPERS
============================================================ */
function resetChart(id) {
  if (CHARTS[id]) {
    CHARTS[id].destroy();
    delete CHARTS[id];
  }
}

function countMap(field) {
  const m = {};
  FILTERED.forEach(e => {
    const v = e.data[field];
    if (!v) return;
    m[v] = (m[v] || 0) + 1;
  });
  return m;
}


/* ============================================================
   CHARTS
============================================================ */
function renderCharts() {
  chartBar("chartTopDx", countMap("diagnosis"));
  chartBar("chartTopAntibiotics", countMap("antimicrobial"));

  chartBar("chartRestricted", Object.fromEntries(
    Object.entries(countMap("antimicrobial")).filter(x =>
      FILTERED.find(e => e.data.antimicrobial === x[0] && e.data.drugtype === "Restricted")
    )
  ));

  chartBar("chartMonitored", Object.fromEntries(
    Object.entries(countMap("antimicrobial")).filter(x =>
      FILTERED.find(e => e.data.antimicrobial === x[0] && e.data.drugtype === "Monitored")
    )
  ));

  chartBar("chartIndication", countMap("indication"));

  chartPie("chartWard", countMap("ward"));
  chartPie("chartDept", countMap("clinicaldept"));

  chartIDSPerf();
  chartBar("chartIDSLoad", countMap("idspecialist"));

  chartDailyTrend();
  chartMonthlyTrend();
}

function chartBar(id, map) {
  const ctx = document.getElementById(id);
  if (!ctx) return;

  resetChart(id);
  CHARTS[id] = new Chart(ctx, {
    type: "bar",
    data: { labels: Object.keys(map), datasets: [{ data: Object.values(map) }] },
    options: { responsive: true }
  });
}

function chartPie(id, map) {
  const ctx = document.getElementById(id);
  if (!ctx) return;

  resetChart(id);
  CHARTS[id] = new Chart(ctx, {
    type: "pie",
    data: { labels: Object.keys(map), datasets: [{ data: Object.values(map) }] }
  });
}

function chartIDSPerf() {
  const ctx = document.getElementById("chartIDSPerf");
  if (!ctx) return;

  resetChart("chartIDSPerf");

  const map = {};

  FILTERED.forEach(e => {
    const name = e.data.idspecialist || "Unassigned";
    if (!map[name]) map[name] = { approved: 0, disapproved: 0 };

    if (e.data.status === "approved") map[name].approved++;
    if (e.data.status === "disapproved") map[name].disapproved++;
  });

  const labels = Object.keys(map);

  CHARTS["chartIDSPerf"] = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label:"Approved", data: labels.map(l => map[l].approved) },
        { label:"Disapproved", data: labels.map(l => map[l].disapproved) }
      ]
    }
  });
}

function chartDailyTrend() {
  const ctx = document.getElementById("chartDailyTrend");
  if (!ctx) return;

  resetChart("chartDailyTrend");

  const daily = {};
  FILTERED.forEach(e => {
    const d = e.data.reqdate;
    if (!d) return;
    daily[d] = (daily[d] || 0) + 1;
  });

  const labels = Object.keys(daily).sort();

  CHARTS["chartDailyTrend"] = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label:"Requests", data: labels.map(l => daily[l]), tension:0.3 }]
    }
  });
}

function chartMonthlyTrend() {
  const ctx = document.getElementById("chartMonthlyTrend");
  if (!ctx) return;

  resetChart("chartMonthlyTrend");

  const monthly = {};
  FILTERED.forEach(e => {
    const d = e.data.reqdate;
    if (!d) return;
    const dt = new Date(d);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;
    monthly[key] = (monthly[key] || 0) + 1;
  });

  const labels = Object.keys(monthly).sort();

  CHARTS["chartMonthlyTrend"] = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets:[{ label:"Monthly Requests", data: labels.map(l => monthly[l]), tension:0.3 }]
    }
  });
}


/* ============================================================
   RAW DATA RESET (CLICK RAW DATA SUMMARY)
============================================================ */
document.querySelectorAll("details summary")[7].onclick = () => {
  FILTERED = ALL_DATA.slice();
  renderKPIs();
  renderRawTable();
  renderCharts();
};


/* ============================================================
   FILTER LISTENERS
============================================================ */
[
  "dateStart", "dateEnd", "modeFilter", "drugTypeFilter",
  "wardFilter", "deptFilter", "idsFilter", "searchBox"
].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", applyFilters);
  el.addEventListener("input", applyFilters);
});


/* ============================================================
   INIT
============================================================ */
window.onload = loadData;

</script>

<!-- CHART JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
